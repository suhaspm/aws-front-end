name: Deploy Frontend to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Archive Frontend
      run: zip -r front-end.zip . -x '*.git*'

    - name: Upload zip and deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: | 
          set -e

          echo "Stopping and removing old frontend container..."
          docker stop front-end || true
          docker rm front-end || true

          echo "Removing old frontend folder..."
          sudo rm -rf ~/front-end

          echo "Unzipping new front end code..."
          rm -f ~/front-end.zip
          exit_code=0
          unzip -o ~/front-end.zip -d ~/front-end || exit_code=$?
          if[$exit_code -ne 0]; then
            echo "Unzip failed!"
            exit 1
          fi

          echo "Building new Docker image..."
          cd ~/front-end
          docker build -t front-end .

          echo "Running new docker container..."
          docker run -d --name front-end -p 3000:80 front-end

    - name: Copy zip to EC2
      uses: appleboy/scp-action@v0.1.4
      with: 
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "./front-end.zip"
        target: "~/front-end.zip"
